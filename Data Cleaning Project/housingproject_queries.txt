USE housingproject;
# 6/17/2022
-- Updated tables to add nulls to empty strings.
-- Removed all data redundancies in the ParcelID & Property Address columns.

#Updating table to add nulls to empty strings------------------------------------------------------------------------

UPDATE 
nashville_housing
SET
ParcelID = CASE ParcelID WHEN '' 
THEN NULL ELSE ParcelID END,

LandUse = CASE LandUse WHEN '' 
THEN NULL ELSE LandUse END,

PropertyAddress = CASE PropertyAddress WHEN '' 
THEN NULL ELSE PropertyAddress END,

SaleDate = CASE SaleDate WHEN '' 
THEN NULL ELSE SaleDate END,

SalePrice = CASE SalePrice WHEN '' 
THEN NULL ELSE SalePrice END,

LegalReference = CASE LegalReference WHEN '' 
THEN NULL ELSE LegalReference END,

SoldAsVacant = CASE SoldAsVacant WHEN '' 
THEN NULL ELSE SoldAsVacant END,

OwnerName = CASE OwnerName WHEN '' 
THEN NULL ELSE OwnerName END,

OwnerAddress = CASE OwnerAddress WHEN '' 
THEN NULL ELSE OwnerAddress END,

Acreage = CASE Acreage WHEN '' 
THEN NULL ELSE Acreage END,

TaxDistrict = CASE TaxDistrict WHEN '' 
THEN NULL ELSE TaxDistrict END,

LandValue = CASE LandValue WHEN '' 
THEN NULL ELSE LandValue END,

BuildingValue = CASE BuildingValue WHEN '' 
THEN NULL ELSE BuildingValue END,

TotalValue = CASE TotalValue WHEN '' 
THEN NULL ELSE TotalValue END,

YearBuilt = CASE YearBuilt WHEN '' 
THEN NULL ELSE YearBuilt END,

Bedrooms = CASE Bedrooms WHEN '' 
THEN NULL ELSE Bedrooms END,

FullBath = CASE FullBath WHEN '' 
THEN NULL ELSE FullBath END,

HalfBath = CASE HalfBath WHEN '' 
THEN NULL ELSE HalfBath END;

/*
Cleaning Data Queries-----------------------------------------------------------------------------------------------------------------
6/20/2022
*/

# ParcelID & Property Address contains data redundancies
SELECT *
FROM nashville_housing
ORDER BY ParcelID;

# Test Join table onto itself to find all data redundancies in ParcelID & Property Address.
# If a.Property Address is null, populate it with the b.Property Address)
SELECT a.ParcelID, a.PropertyAddress, b.ParcelID, b.PropertyAddress, IFNULL(a.PropertyAddress, b.PropertyAddress)
FROM nashville_housing a
INNER JOIN nashville_housing b
ON  a.ParcelID  = b.ParcelID
AND a.UniqueID !=  b.UniqueID
WHERE a.PropertyAddress IS NULL;

#Update the nashville table using aliases to get rid of null values (join onto itself).
UPDATE nashville_housing a
	INNER JOIN nashville_housing b
	ON  a.ParcelID  = b.ParcelID
	AND a.UniqueID !=  b.UniqueID
SET 
	a.PropertyAddress = IFNULL(a.PropertyAddress, b.PropertyAddress)
WHERE a.PropertyAddress IS NULL;

# Re-run select statement and ensure that each row of ParcelId & PropertyAddress does NOT contain data redundancies
SELECT *
FROM nashville_housing
ORDER BY ParcelID;

-- Turn addresses into normalized individual columns for "Property Address" (Address, City, State)------------------------------------------------------------------------------------
SELECT PropertyAddress
FROM nashville_housing
ORDER BY PropertyAddress;

# Use SUBSTRING in PropertyAddress column to find addresses and stop once you get to the comma. 
# Use -1 to remove comma from results.
# To grab the city, locate the comma and use + 1 to grab everything after it.
SELECT SUBSTRING(PropertyAddress, 1, LOCATE(',', PropertyAddress) -1) AS Address,
SUBSTRING(PropertyAddress FROM (LOCATE(',', PropertyAddress) + 1 )) AS City
FROM nashville_housing;

/* ALTERNATIVE METHOD USING SUBSTRING_INDEX
As of 6/22/2022
SELECT SUBSTRING_INDEX(PropertyAddress, ',', 1) AS PropertySplitAddress,
SUBSTRING_INDEX(PropertyAddress, ',', -1) AS PropertySplitCity
FROM nashville_housing;
*/

# Alter and update Nashville table with the normalized Property Address, city, & state using previous select statement.
ALTER TABLE nashville_housing
ADD PropertySplitAddress VARCHAR (500);

UPDATE nashville_housing
SET PropertySplitAddress = SUBSTRING(PropertyAddress, 1, LOCATE(',', PropertyAddress) -1);

ALTER TABLE nashville_housing
ADD PropertySplitCity VARCHAR (500);

UPDATE nashville_housing
SET PropertySplitCity = SUBSTRING(PropertyAddress FROM (LOCATE(',', PropertyAddress) + 1 ));

/*
6/22/2022 
*/
-- Turn addresses into normalized individual columns for "OwnerAddress" -------------------------------------------------------------------------------------------------------
# Use SUBSTRING_INDEX this time instead of regular SUBSTRING
SELECT SUBSTRING_INDEX(OwnerAddress,',', 1) AS OwnerStreetAddress,
SUBSTRING_INDEX(SUBSTRING_INDEX(OwnerAddress, ',', 2), ',', -1) AS OwnerCity,
SUBSTRING_INDEX(OwnerAddress,',', -1) AS OwnerState
FROM nashville_housing;

SELECT SUBSTRING_INDEX(PropertyAddress, ',', 1),
SUBSTRING_INDEX(PropertyAddress, ',', -1)
FROM nashville_housing;

# Alter and update Nashville table with the normalized OwnerAddress, city, & state using previous select statement.
ALTER TABLE nashville_housing
ADD OwnerStreetAddress VARCHAR (500);

UPDATE nashville_housing
SET OwnerStreetAddress = SUBSTRING_INDEX(OwnerAddress,',', 1);

ALTER TABLE nashville_housing
ADD OwnerSplitCity VARCHAR (500);

UPDATE nashville_housing
SET OwnerSplitCity = SUBSTRING_INDEX(SUBSTRING_INDEX(OwnerAddress, ',', 2), ',', -1);

ALTER TABLE nashville_housing
ADD OwnerSplitState VARCHAR (500);

UPDATE nashville_housing
SET OwnerSplitState = SUBSTRING_INDEX(OwnerAddress,',', -1);
